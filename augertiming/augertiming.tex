% !TEX root = ../main.tex

\chapter{Timing for AugerPrime}
\label{augtiming}
In this chapter, we will investigate the timing performance of two aspects of the AugerPrime upgrade. To set the stage, we will have a discussion of some timing basics. After this, we move on to the topic of GPS receiver selection for AugerPrime. We motivate this endeavor, discussing the need for a new receiver selection due to availability, and then talk about the absolute, relative and temperature timing tests done for the M12M and SSR-6Tf receiver models. To conclude this section, we justify our recommendation of the SSR-6Tf, which has been accepted and acted on by the collaboration. 

The measurement for the time resolution of the upgraded SD stations is then outlined. We give our methods for two different measurements of the time resolution, one of which requires us to calculate a physical error factor for arrive directions of triggering showers, and the other which involves using a cable to time synchronization pulses between two detectors. We find the time resolution to be $\sim$8ns and that both methods are in agreement. 
\section{Timing Basics}
In order to keep time in any context, we must first start with a clock. Even back to the days of Galileo or John Harrison, clocks have been based on the simple principle of an oscillator, keeping time by `ticking' at a precise rate. In today's context, most clocks are kept by electronic oscillators with a variety of methods employed to generate the signal. In the case of the UUB, this is an Abracon ABLJO-V-120.000MHZ-T2, which uses the 3rd overtone of a quartz crystal to keep time. By modulating the voltage across this VCXO, we can control its vibrational frequency. 

The field of air shower physics usually requires its time-tagging hardware to accomplish two tasks. First, it must time the occurrence of events, which can be broadly described in terms of timing the rising edge of a logic pulse. Generally, the main task of trigger hardware and firmware is the generation of a logic pulse which corresponds to the time of the trigger, often offset by some known amount. The second task of a time-tagging module in an experiment such as Auger, is to accomplish frequency distribution, which is technical jargon for synchronizing clocks at a very fine level.

For frequency distribution, Auger uses the GPS constellation's space-borne bank of atomic clocks. Using the techniques outlined in \autoref{gps}, the GPS receiver can calculate the time of a GPS second to a handful nanosecond's accuracy. These GPS seconds are timed by the receiver's 1PPS, which comes in the form of a logic pulse. By counting the ticks of an oscillator from when a 1PPS comes in to when an event occurs, and then from the event to the next 1PPS, we can interpolate to find the point in the second when the event occurred. This process is encapsulated in \autoref{insec} below. 
\begeq{
  \label{insec}
  t_e=\frac{N_e}{N_{i+1,PPS}-N_{i,PPS}}.
}
Here, we have $N_e$, the number of counts up to an event, $N_{i,PPS}$ the counter value at the preceding PPS, and $N_{i+1,PPS}$, the counter at the current (i.e. subsequent) PPS. This gives us $t_e$, the time (in seconds) of an event within a GPS second, and then we can simply use the telemetry messages from the receiver or the counter from the time tagging module to put together the GPS second. There is some difficulty in finding the number of leap seconds to date, but this can be requested from the receiver periodically. With these pieces of information, we can put together a full decimal time-tag of when an event occurs, allowing reconstruction of air showers and comparison with data from other experiments.

To get the highest possible accuracy in time tagging, we will need to apply the clock granularity message. This has two effects on \autoref{insec}: first, the clock granularity messages (\autoref{sawtooth}) from the proceeding and current PPS events give the information that we need to adjust how many seconds the number of calibration counts, $N_{cal}=N_{i+1,PPS}-N_{i,PPS}$, represents. The preceding sawtooth message then tells us how the end of second represented by the PPS needs to be shifted relative to GPS time to be correctly aligned.

We address the first problem by applying a correction to $N_{cal}$:
$$N_{cal}'=\left(N_{i+1,PPS}-N_{i,PPS}\right)\left(1+10^{-9}(\Delta t_{curr}-\Delta t_{last})\right),$$
where the $\Delta t_i$ correspond to the preceding and current saw tooth ($last$ and $curr$, respectively) in nanoseconds, as it is delivered by the receiver. The second problem is fixed by simply adding the preceding sawtooth ($\Delta t_{last}$) to the event time. This gives us a new $t_e'$ of:
\begeq{
  \label{insec2}
  t_e'=\frac{N_e}{\left(N_{i+1,PPS}-N_{i,PPS}\right)\left(1+10^{-9}(\Delta t_{curr}-\Delta t_{last})\right)}*10^9+\Delta t_{last}.
}
In this formulation, we have added the factor of $10^9$ to put $t_e'$ into units of nanoseconds, which is the usual convention for the type of timing accuracy measurements we will be doing in this work. This is in line with the framework set forth by the original group who worked on GPS verification for the initial Auger construction (documented in \textcite{firsttag}).

For final science purposes, we usually want to give event times in number of GPS seconds, including the lengthy portion of the event time which will come after the decimal. While none of the measurements and activity documented in this chapter made use of it, a good place for help determining the number of leap seconds, and incidentally the conversion between UTC and GPS time, is the LIGO webpage on the topic, \url{https://www.gw-openscience.org/gps/}. The discussion on timing standards and accuracy is continued in \autoref{stabacc}.
\section{GPS Receiver Selection Testing} %edit this section carefully, try to eliminate unnecessary references since the specsheet is somehow not publicly available. Or you can just make it available...
\label{gpstest}
In order to operate an observatory like Auger, precise timing synchronization is needed amongst the SD stations. This is accomplished via GPS timing boards. While the original receiver for the AugerPrime upgrade, the i-Lotus M12M \cite{m12mspec}, was initially chosen before the author began working with the Auger Collaboration, the manufacturer was unable to meet the volume of our request when the time came to deliver. Accordingly, we had to test a new GPS unit, the Synergy SSR-6Tf. During testing, the manufacturer came back and informed us that they had found the needed parts. At this time we had made significant progress towards vetting the new receiver. 

For this section, we will first discuss the availability situation as mentioned above in detail. We then move on to a brief discussion of the two models of receivers. After this, the first test, for absolute timing, is outlined and then results are shown. We then discuss the method for the relative timing and temperate dependence tests, and show their results. Finally, we make the recommendation to purchase the SSR-6Tf and justify it from the data and context.

\subsection{Concerns regarding the availability of the i-Lotus M12M}
i-Lotus is a company in Singapore that received technology from
Motorola who no longer manufactures GPS receivers (theirs were the units used for the UB). The i-Lotus
M12M~\cite{m12mspec} has been long anticipated as the selected GPS receiver for
the UUB. Currently, all but two UUBs within the Engineering Array
are operating with i-Lotus M12M GPS receivers.

In late 2018, a purchase order was placed to obtain all M12Ms required
for the Auger upgrade.  The order was placed via Synergy Systems
LLC, the licensed reseller for i-Lotus in the US. The
hope and expectation was that i-Lotus would accept the order and
deliver the required M12M units to CWRU where our group would begin to validate and
calibrate the units for eventual deployment into the upgraded
array.

However, after the purchase order was placed, we were informed that
i-Lotus would have substantial delays of at least several months in
responding to our order due to an unavailability of component parts.
By late 2017, our options were (1) to wait at least several months
with the expectation that the parts shortage might improve, or (2) to
consider an alternative to the i-Lotus M12M called the Synergy SSR-6Tf~\cite{ssr}.

Since this time, we have been working with representatives from
Synergy Systems to consider our options and to explore and validate
the performance of the SSR-6Tf as a possible alternative to the M12M.
During the intervening months, while testing the SSR-6Tf, we
received updates that indicate that i-Lotus may now have components to
fill some or potentially all of our order for the M12Ms.  At this time, the group at
CWRU has completed bench tests and temperature dependence tests to
compare the performance and reliability of the M12M and the SSR-6Tf. Additionally, two SSR-6Tfs are installed in the field (in Trak Jr. and Clais Jr.) and have been operating for over 6 months without issue.
%Here we present our results and our recommendations.

\subsection{Specifications:  i-Lotus M12M vs. the SSR-6Tf}%might want to add something about the UT+ here
\label{receivers}
The SSR-6Tf is a GPS receiver made specifically for accurate timing
applications.  The unit is made by Synergy Systems (the same company
that acts as the reseller for i-Lotus in the US).  The SSR-6Tf is designed to
optionally operate in ``compatibility mode'' that provides nearly
identical functionality to that of the i-Lotus M12M with comparable or
better timing performance.  In compatibility mode, the SSR-6Tf is
designed to function as a ``drop in replacement'' for the
M12M. 

Both units specify operating temperatures in the range -40C to 85C.
The i-Lotus draws 123 mWatts power while the SSR-6Tf draws 155 mWatts.
Both receivers have the same form factor, pinout and antenna
connectors.

By definition, timing accuracy here relates to the accuracy of timing for
1 Pulse-Per-Second (1PPS) output pulses. For every measurement reported
here, we apply granularity corrections (so-called `sawtooth', as explained in \autoref{sawtooth})
which are reported for each 1PPS pulse via internal serial line from the GPS
receiver.

\subsection{Initial Bench Tests:  Absolute GPS Timing}

Our first tests were conducted on the bench.  GPS antenna signals were routed into the
laboratory from a roof-top antenna.  Both the SSR-6Tf and the M12M have been exercised
for many 100's of hour in our laboratory without fault.

We find that the SSR-6Tf as delivered by Synergy cold starts into
Motorola compatibility mode.  For both cold and warm starts, the
SSR-6Tf is much faster than the M12M (usually seconds vs.~minutes).

\subsubsection{Test Stand for Absolute GPS Timing} 

% \figin{Bench test schematic of time-tagging system to measure absolute
%   timing of the Synergy Systems SSR-6Tf vs.~the i-Lotus M12M GPS
%   receivers.}{fig_absolute_rob.png}{3.5in}
\label{timprime}
\begin{figure}[h!]
\centering
\includegraphics[width=4 in]{./images/fig_absolute_rob.png}
\caption[Absolute Timing Test Diagram]{Bench test schematic of time-tagging system to measure absolute timing of the Synergy Systems SSR-6Tf vs.~the i-Lotus M12M GPS receivers.}
\label{fig_absolute}
\end{figure}
For our initial tests, we compare absolute time-tagging performance of
the SSR-6Tf against that of the M12M over a range of time-scales using
a GPS-disciplined Atomic Clock.  Before each test, the atomic clock is
trained for several hours to the GPS constellation's timing. The clock
we are using is a FS725 Rubidium frequency standard from Stanford
Research Systems, which is trained (disciplined) by the GPS constellation.
Individual 1PPS produced by the disciplined FS725 provide an accurate
time standard to better than a few 100s of picoseconds over timescales
from seconds to days.

\autoref{fig_absolute} shows a schematic diagram for the absolute timing test stand.  Our bench test timing test stand, TIM (see \autoref{tim} for more details), is based on a ZedBoard\textsuperscript{TM} and runs our own 750~Mhz time-tagging system firmware
through a GPIO interface.  Operation of the board is controlled by a
Standalone linux operating system script. This script
controls the time tagging system firmware, data logging, and serial
communications with both the GPS and the atomic clock.  On a
pulse-by-pulse basis we measure the timing differences between the
1PPS from the atomic clock and the corrected 1PPS from each receiver. The
final result will be a plot of the standard deviation of the pulse arrival
times as a function of timing window scanned over to calculate the
variance. The derivative of this is directly related to the Allen
Deviation. 



% \figin{Absolute time-tagging: The standard deviation of each
%   receiver's 1PPS compared to the 1PPS of the FS725 atomic clock.  The
%   i-Lotus M12M is shown in red.  The Synergy Systems SSR-6Tf is shown in
%   blue.  The shaded areas correspond to a 1-$\sigma$ error region for
%   each receiver.}{m12m_vs_ssr.pdf}{6in}

\subsubsection{Results for Absolute GPS Timing} 
\begin{figure}[H]
\centering
\includegraphics[width=5.8 in]{./images/m12m_vs_ssr.pdf}
\caption[Absolute Timing Test Results]{Absolute time-tagging: The standard deviation of each
  receiver's 1PPS compared to the 1PPS of the FS725 atomic clock.  The
  i-Lotus M12M is shown in red.  The Synergy Systems SSR-6Tf is shown in
  blue.  The shaded areas correspond to a 1-$\sigma$ error region for
  each receiver.}
\label{absolute}
\end{figure}
\autoref{absolute} shows our results for absolute time-tagging of sawtooth-corrected 1PPS GPS timing for the M12M
vs. the SSR-6Tf. We show the RMS difference between the measured 1PPS
for each receiver vs.~ the atomic clock standard as measured on
timescales ranging from a few seconds to 24 hours.

In terms of short-term timing accuracy (timescales less than a few
minutes), the SSR-6Tf reports a timing precision of 2.3~ns while the M12M
reports a timing precision of 2.8~ns.  Absolute timing errors gradually
increase for both receivers over timescales of a few hours,
presumably due to drifts in the electron content of the ionosphere. Over many hours, the long-term absolute
timing resolution of the SSR-6Tf is generally better than about 5
nanoseconds while the M12M is closer to 6 nanoseconds. We
  find that on any time-scale from seconds to hours, the SSR-6Tf
  outperforms the M12M by approximately one nanosecond for absolute
  timing accuracy.  We note that in terms of the performance
specifications required for the the AugerPrime upgrade (e.g., better
than 8 nanoseconds absolute timing) both the SSR-6Tf and the i-Lotus M12M meet the
required specification.

\subsection{Relative GPS Time-Tagging}

Although absolute timing accuracy is an important performance
parameter for GPS timing, in the field at Auger the {\em
  relative timing} between two receivers is the more important
quantity, since only timing differences between receivers will impact
the reconstruction.  To verify relative timing accuracy, we developed
a second test stand configured to accept telemetry data from two GPS
units and to compute the difference in arrival times of their
(sawtooth corrected) 1PPS time signals. We also use this configuration
to explore possible temperature dependence of the arrival time of the
1PPS on the order of nanoseconds. 


\subsubsection{Test Stand for Relative GPS Timing and Temperature Dependence} 


% \figin{Bench test schematic of time-tagging system to measure relative
%   timing of the Synergy Systems SSR-6Tf vs.~the i-Lotus M12M GPS
%   receivers, including temperature dependence.}{fig_relative_rob.png}{3.5in} 
\begin{figure}[H]
\centering
\includegraphics[width=4 in]{./images/fig_relative_rob.png}
\caption[Relative Timing Test Diagram]{Bench test schematic of time-tagging system to measure relative timing of the Synergy Systems SSR-6Tf vs.~the i-Lotus M12M GPS receivers, including temperature dependence.}
\label{fig_relative}
\end{figure}

\autoref{fig_relative} shows the schematic setup of our test
for relative timing and temperature dependence.  The configuration is
closely matched to that used for previous time-tagging calibration and
temperature dependence measurements conducted and reported by the
CWRU group~\cite{brandt}. For relative GPS time-tagging we select two GPS
receivers of the same model and then measure the relative arrivals of their sawtooth-corrected 1PPSs. These measurements provide a series of time differences from which timing precision (standard deviation) can be computed over long-duration tests.

From previous results using a 250~MHz version of this system, the
results of the temperature and relative timing tests are available in
the linked document and will be cited below. 


\subsubsection{Temperature and Relative Timing Test} %check july collaboration report for more testing on the M12M


\begin{figure}[H]
\centering
\includegraphics[width=2.9 in]{./images/ssr_const_temp_fit.pdf}
\includegraphics[width=2.9 in]{./images/m12m_first_week.pdf}
\caption[SSR-6Tf Relative Timing]{Left: the relative timing test for the SSR-6Tf. Right: the relative timing test for the M12M. These are the time differences of the sawtooth corrected }
\label{ssrtest0}
\end{figure}
In comparison to the $\sim$1.45ns standard deviation in the time differences of the
M12Ms, the SSR has a standard deviation of 1.3 ns, which is the
instrumental uncertainty of the 750 Mhz time-tagging system used for
this testing \cite{brandt}. It is worth noting that it's possible the
SSR-6Tf has an even better timing accuracy, but it has reached the
ability of our test bench to time-tag it. To reiterate, these time differences represent two identical receivers timed against each other with the TIM unit (\autoref{tim}). The data have been filtered
for counter rollover and sawtooth rollover outliers which account for
less that 1\% of the second by second time differences recorded. These measured timing precisions are in line with the manufacturer's presented figures \cite{ssr,m12mspec}.

For the temperature dependence testing, the profile of temperatures is
derived from a study of the weather at the Auger site \cite{brandt}. The M12M shows
some temperature dependence during extreme temperature ramps, but the
mean of its 1PPS arrival time does not depend on temperature, whereas
SSR-6Tf does show direct dependence on the temperature. In spite of
this, the performance of the SSR is still better than that of the M12M
when put under thermal stress.

% \figindos{Left: A time series test of the SSR-6Tf's performance with sawtooth
%   correction measured against another sawtooth corrected SSR-6Tf. The
%   data has been corrected for counter and sawtooth rollover
%   errors. Right: A histogram of the time series.}{ssrtest0.png}{3in}{const_temp_histo.pdf}{3 in}
\begin{figure}[H]
\centering
\includegraphics[width=2.9 in]{./images/ssrtest0.pdf}
\includegraphics[width=2.9 in]{./images/const_temp_histo.pdf}
\caption[SSR-6Tf Relative Timing]{Left: A time series test of the SSR-6Tf's performance with sawtooth correction measured against another sawtooth corrected SSR-6Tf. The data has been corrected for counter and sawtooth rollover errors. Right: A histogram of the time series.}
\label{ssrtest0}
\end{figure}

% \figindos{Two runs from the temperature testing of the
%   SSR-6Tf.}{ssrtest1.png}{5in}{ssrtest2.png}{5in}

\begin{figure}[H]
\centering
\includegraphics[width=2.9 in]{./images/ssrtest1.pdf}
\includegraphics[width=2.9 in]{./images/ssrtest2.pdf}
\caption[SSR-6Tf Temperature Testing]{Two runs from the temperature testing of the
  SSR-6Tf.}
\label{ssrtemptest}
\end{figure}


% \figindos{Plots from Dan Brandt's original analysis of the M12M's
%   temperature dependence.}{brandt_test1.png}{5.5
%   in}{brandt_test2.png}{5.5in}
\begin{figure}[H]
\centering
\includegraphics[width=2.9 in]{./images/brandt_test1.png}
\includegraphics[width=2.9 in]{./images/brandt_test2.png}
\caption[M12M Temperature Testing]{Plots from Dan Brandt's original analysis of the M12M's
  temperature dependence, available in \textcite{brandt}.}
\label{m12mtemptest}
\end{figure}
%\begin{figure}[H]
%\centering
%\includegraphics[width=5.5 in]{./images/ssrtest0.pdf}
%\includegraphics[width=5.5 in]{./images/const_temp_histo.pdf}
%\caption[SSR-6Tf Relative Timing]{Top: A time series test of the SSR-6Tf's performance with sawtooth correction measured against another sawtooth corrected SSR-6Tf. The data has been corrected for counter and sawtooth rollover errors. Bottom: A histogram of the time series.}
%\label{ssrtest0}
%\end{figure}
%
% \figindos{Two runs from the temperature testing of the
%   SSR-6Tf.}{ssrtest1.png}{5in}{ssrtest2.png}{5in}
%
%\begin{figure}[H]
%\centering
%\includegraphics[width=5.5 in]{./images/ssrtest1.pdf}
%\includegraphics[width=5.5 in]{./images/ssrtest2.pdf}
%\caption[SSR-6Tf Temperature Testing]{Two runs from the temperature testing of the
%  SSR-6Tf.}
%\label{ssrtemptest}
%\end{figure}
%
%
% \figindos{Plots from Dan Brandt's original analysis of the M12M's
%   temperature dependence.}{brandt_test1.png}{5.5
%   in}{brandt_test2.png}{5.5in}
%\begin{figure}[H]
%\centering
%\includegraphics[width=5.5 in]{./images/brandt_test1.png}
%\includegraphics[width=5.5 in]{./images/brandt_test2.png}
%\caption[M12M Temperature Testing]{Plots from Dan Brandt's original analysis of the M12M's
%  temperature dependence, available in \textcite{brandt}.}
%\label{m12mtemptest}
%\end{figure}

\subsection{Conclusions}
We have tested the M12M and SSR-6Tf receivers using two different
methods, first looking at the absolute timing accuracy over different
time scales and second looking at the timing of each receiver relative
to another receiver of the same model under temperature variation. The
absolute accuracy test shows that, while both models perform
satisfactorily for use in AugerPrime, the SSR-6Tf has slightly better
performance over all time scales. According to our relative timing
tests, the SSR-6Tf outperforms the M12M; where the
M12M has a standard deviation in time differences of $\sim$1.45 ns, the
SSR has a relative timing accuracy of $\sim$1.3 ns or better. The
temperature dependence testing showed that M12M receivers have a
temperature dependence during large temperature changes but stabilize
when the temperature does. On the other hand, the SSR-6Tf shows a
direct temperature dependence where the mean of the time differences
depends on the temperature. If the SSR was less accurate, this could
cause issues, but even with this direct dependence the SSR is more
accurate than the M12M.

All things considered, the SSR-6Tf is a newer receiver which
outperforms the M12M in all relevant parameters. Pending testing in
the field over the next few weeks, our recommendation for the Auger
Prime upgrade is to purchase the SSR-6Tf receivers when Synergy is
ready to deliver their final version.


\section{AugerPrime Time-Resolution} %tres1 is the original time resolution reference
\label{money}%add tres1 to bibtex
An essential parameter of shower reconstruction for Auger is the time resolution of its detectors. This affects directional reconstruction amongst other observables, and if the time-resolution is low enough it may contribute to helping determine the muonic content of incident air showers (see \textcite{mupart} and \autoref{showercomp}). With the integration of AugerPrime completed, the time-tagging module has been added in a similar way to other IP (see \autoref{integration}). At this point, it has been running continuously for over two years in the engineering array without issue, thereby confirming its reliability. This then leaves us to confirm the timing performance of the whole system, end-to-end. 

In this section, we will first outline the basic facets of the time-tagging system. We will then move on to a discussion of each of two methods to measure the time resolution of the upgraded stations and the results of the measurements. First we will discuss a method using only air showers, and then a method using a synchronization cable. Finally, we will compare the results of these two tests and their uncertainties. 

The timing tests will be performed in the stations Trak Jr., Clais Jr. and Peteroa Jr., which have been dubbed the `timing triplet' and are some of the engineering array stations most frequently used for UUB verification and testing. A map of their positions is shown in \autoref{eamap}.
\begin{figure}[H]
\centering
\includegraphics[width=5.5 in]{./images/eamap.pdf}
\caption[Timing Triplet Map]{Here we have a map of the relative positions of the stations in the EA. The distance between  Trak Jr. and Clais Jr. is $\sim$20m and the distance between Trak Jr. and Peteroa Jr. is 11m (this is somewhat obscured since we have used the global Auger coordinate system on these axes).}
\label{eamap}
\end{figure}

\subsection{Time-Tagging Specifications and Ports} %check and decide how much of this stuff you want in here, including the tables
In comparison to the time-tagging module for TIM, shown in \autoref{ttagdiag}, the final time-tagging module for AugerPrime integrates all of the GPIO connections into internal wires and registers and makes some of the calculations that are done in post-processing for TIM. This change is a result of the SDEU meeting held at Michigan Technological University in October of 2014, where a new specification for the system was written, eschewing the individual GPIO connections for a more efficient structure of internal connections and a single AXI connection to communicate with the PS. Through this connection, Direct Memory Addressing (DMA) is done to present the module's outputs directly into the memory of the processing system. This puts the burden of transferring data on the PL which will handle it constantly and without extra overhead. The PS then has direct access to this information when forming T3 packets and taking care of housekeeping tasks.

\figwrap{Here we have the block diagram for the time-tagging module in the UUB. This shows the connections to the AXI bus and the external connections to other PL or UUB locations.}{./images/ttagbd.pdf}{2 in}{l}{Time-Tagging Module IP Element}{ttagbd}

The block diagram and AXI I/O of the time-tagging module are shown in \autoref{ttagbd} and \autoref{ttagspec} respectively. The block diagram inputs and outputs interface to other parts of the PL or UUB, while the AXI I/O provides the means to communicate the relevant information to the PS. There are effectively three types of timing going on in the module. The first, the `fast' time tagging line is meant for showers, the `slow` time-tagging line is meant for muons and there is a final line with a much simpler signal chain and register structure for the GPS calibration. 

Each of the muon and shower lines have four registers fed by counter values from the 120Mhz clock and four registers (one tied to each of the 120Mhz clock registers) which contain the GPS second. These are multiplexed to decrease dead time, i.e. when one is full, an address register containing the next writable timing register's address is incremented, and then when a new event comes in we repeat the process, writing the new events time-tag into the new register and again incrementing the address register appropriately. These, and all other AXI-connected registers are 32-bits wide. 

\begin{table}
\begin{center}
%
%\begin{tabular}{c c}
%USER TIME TAGGING PORTS& DESCRIPTION \\
%clk\_120m & 120MHz clock, formerly 100MHz clock in AN\\
%pps gps & 1 pulse per second \\
%evtcnt &[3:0] tag from trigger memory for shower buffer \\
%evtcntm &[3:0]  tag from trigger memory for muon buffer \\
%evtclkf  &fast trigger\\
%evtclks  &slow trigger\\
%dead& dead time \\
%address\_wsb& [1:0] shower buffer write address \\
%address\_rsb& [1:0] shower buffer read address\\
%address\_wmb& [1:0] muon buffer write address \\
%address\_rmb& [1:0] muon buffer read address \\
%\end{tabular}
\begin{tiny}
\begin{tabular}{c c c}
AXI REGISTER NAME&ADDRESS OFFSET& DESCRIPTION \\
Onanosec&0 &value of nanosecond (fast) counter at time of fast trigger \\
Oseconds&1 &value of seconds counter at time of fast trigger \\
c120mout\_sb&2& value of nanosec. counter at last pps occurrence and fast trigger \\
c120calout\_sb&3&value of calibration counter at last pps occurrence and fast trigger \\
slowtriggerns&4&value of nanosecond counter at time of slow trigger \\
slowtriggersec&5&value of seconds counter at time of slow trigger \\
c120mout\_mb&6&value of nanosec.  counter at last pps occurrence and slow trigger \\
c120calout\_mb&7&value of cal. counter at last pps occurrence and slow trigger \\
timeseconds&8&value of seconds  counter at last pps occurrence when read by ps \\
c120mout\_ps&9&value of nanosec counter at last pps occurrence when read by ps \\
c120calout\_ps&10&value of cal counter at last pps occurrence when read by ps \\
c120deadout&11&value of dead counter at last pps occurrence when read by ps \\
teststatus&12&value of event status bits for test purposes only \\
ttagctrl&13&control register contains time tag soft reset control bit \\
ttagid&14&reads back the binary ascii value of the letters ``ttag''\\
spare&15&write and read any value \\
\end{tabular}
\end{tiny}
\end{center}
\caption[Table of Register Assignments]{These tables, reproduced from \textcite{bobttag}, show the register assignments for the AugerPrime Time-Tagging module.}
\label{ttagspec}
\end{table}

\subsection{Coincident Showers Method}
When Auger was initially commissioned, the timing resolution of the stations was determined via a `coincident showers' method. This method was not detailed in any publication, but its results are briefly discussed in \textcite{fddiam}. The basic method that they use is to calculate a Gaussian uncertainty quantifying the delay between stations from the arrival directions of low energy showers (the \textit{physical dispersion} as it is sometimes referred to). They then take the coincident time-tags within a physically reasonable window, find their width by fitting a Gaussian to it, and then they subtract off the error from the arrival directions in quadrature. 

We will use this same method to analyze coincident time-tags between Trak Jr. and Peteroa Jr. In general, we pick a month's worth of data. We cut out time-tags outside of 150ns difference; this range allows us to ensure that there are not a large amount of unphysical outliers in the coincident showers. After this, we fit a Gaussian to the distribution and take its standard deviation as the uncorrected time resolution, $\sigma_{tot}$. We will evaluate the time differences according to the formula shown in \autoref{insec2}.

To form the uncertainty from the time delay between stations, we can take the commonly found derivation of the distance from a point to a plane and use it to calculate the distance the shower plane must travel after it has hit one station to be seen by the other station. We can use spherical coordinates to describe the arrival direction of the shower and load this data directly from Auger's \textit{Herald} data product. The distance the plane must travel as a function of local zenith angle $\theta$ and azimuth $\phi$ is:
\begeq{
\label{tdelay}
d \sin\theta \sin\phi ,
}
where $d$ is the separation between the stations we are testing. To be clear, $\theta$ is defined to be the zenith angle, i.e. 0 if the shower hits perpendicular to the atmosphere. With this established, we feed $\theta$ and $\phi$ values into \autoref{tdelay}, make a histogram of the delays and then measure its width by fitting a Gaussian to it. This distribution will be referred to as the `distance-to-detector` histogram. We then divide the fitted width by $c$ and put the resulting time delay in units of nanoseconds. To find the final time-resolution, consider the following statement of the total timing error:
$$
\sigma_{tot}=\sqrt{\sigma_{shower}^2+\sigma_{det1}^2+\sigma_{det2}^2}=\sqrt{\sigma_{shower}^2+2\sigma_{det}^2}\implies\sigma_{det}=\sqrt{\frac{\sigma_{tot}^2-\sigma_{shower}^2}{2}}.
$$
We assume only that the detectors involved in the timing analysis will have the same timing errors (they are identical). Care has been taken by the Observatory's on-site scientists to ensure the firmware version is the same between the testing stations. At this point we have everything we need to calculate the time resolution using coincident showers.
\subsubsection{Shower Selection for Arrival Directions}
\label{justify}
Ab initio, it may be advantageous for us to make some energy cuts on the showers we use to assess the error due to shower arrival directions. We make this statement here for clarity and transparency: any selection of events gives approximately the same calculated standard deviation of the distribution of time delays due to arrival directions. The directly calculated standard deviation for the selections of data corresponding to \textless 1 EeV, 1 EeV \textless $E$ \textless 20 EeV, 20 EeV \textless $E$ \textless 40 EeV and  \textgreater 40 EeV all give standard deviations with .1 ns of 18.25 ns (18.28 $\pm$ .08 ns as a measurement).  Cuts for low energy events give non-Gaussian distributions, with a high center peak and heavy tails on either end. Attempts to fit a Gaussian to these fail without excessive data massaging or additional degrees of freedom in the fit. Only the highest energy bin from above has a convergent fit. 

Looking at this, we will proceed to use the fitted standard deviation for the highest energy bin, making the assumption that this is sufficient. There is some physical motivation to do this since high energy showers will be guaranteed to trigger both detectors if they are within a suitable distance, while even very close low energy showers may not cause a co-trigger. If we find that using this assumption delivers unphysical or disagreeing results with the synchronization cable method, we can revisit this assumption and look at methods of handling non-Gaussian noise. 
\subsection{Coincident Showers Results}
Proceeding as outlined above, we find the distribution of distances-to-detector to be 5.4 $\pm$ 1.1 m (error from fitting) with an adjusted $r^2$ of .98, indicating an acceptable but not great fit. From this, we get a standard deviation of the time delays of 18.1 $\pm$ 3.5 ns. The distribution and fit are shown in \autoref{arrdist}.
\begin{figure}[H]
\centering
\includegraphics[width=4.5 in]{./images/arrdist.pdf}
\caption[Distribution of Distances-to-Detector]{Shown here is a histogram and Gaussian fit of the distance-to-detector calculated based on \autoref{tdelay} and the energy cut discussed in \autoref{justify}.}
\label{arrdist}
\end{figure}
To find the distribution of time differences caused by coincident showers on the two stations, we apply the methods outlined above to data from January and February of 2018. These months are chosen arbitrarily. Their data are displayed in \autoref{fintdiffs}.
\begin{figure}[H]
\centering
\includegraphics[width=2.9 in]{./images/jan_time_diffs.pdf}
\includegraphics[width=2.9 in]{./images/feb_time_diffs.pdf}
\caption[Coincident Shower Time Differences]{Here we have the distributions of time differences between Trak Jr. and Peteroa Jr. for January and February of 2018 each fitted with a Gaussian whose standard deviation is shown in the figure. Each distribution contains $\sim$3600 data points.}
\label{fintdiffs}
\end{figure}
We can pick either month, their standard deviations are within uncertainties of each other. Averaging them and propagating uncertainties we get an uncorrected time resolution of 21.97 $\pm$ .25 ns. From here, we can calculate our final result with propagated uncertainties:
\begeq{
\sigma_{det}=\sqrt{\frac{21.97^2-18.08^2}{2}}=8.8\,\pm\,3.6 \mbox{ ns}.
}
\subsection{Synchronization Cable Method}%might want to check when UUBv2 was actually installed
Another way to measure the timing of the closely placed EA stations is to connect a cable to the trigger output of one station and bring it into one of the ADC channels of the other. This connection was made between Trak Jr. and Clais Jr. and stayed in place from early 2018 until August of that year, when the second version of the UUB was installed. The UUBv2 is currently being debugged and will soon be operational. 

\begin{figure}[H]
\centering
\includegraphics[width=2.9 in]{./images/syncpulse_fit.pdf}
\includegraphics[width=2.9 in]{./images/showerpulse.pdf}
\caption[Distribution of Distances-to-Detector]{Here we have the distributions of time differences between Trak Jr. and Peteroa Jr. for January and February of 2018 each fitted with a Gaussian whose standard deviation is shown in the figure. Each distribution contains $\sim$3600 data points.}
\label{pulseshapes}
\end{figure}

By timing the trigger in Clais Jr. and differencing it with the arrival time of the synchronization pulse (trigger out) in Trak Jr. we can test the end-to-end timing resolution of the detector without having to account for any physical dispersion from showers. It should also be kept in mind that we are looking for the width of a distribution, so fixed offsets in the time difference calculation can be disregarded. The trigger in Clais is fixed at 1/3 of the way through the trace in each trigger by the output of the ring buffer it is kept in. The GPS time is latched by the time-tagging system at the end of the trace recording, and we will need this and sawtooth corrections for this calculation. The event time calculation will come from \autoref{insec2}. We will find the leading edge of the synchronization pulse by fitting an error function to it of the form:
%def sqrerfit(x,x1,x2,a,y0):
%    return a/2*(spec.erf(x-x1)-spec.erf(x-x2))+y0
\begeq{
  f(x)=\frac{a}{2}\left(erf(x-x_1)-erf(x-x_2)\right)+y_0,
}
where $x_1$ is the center of the rising edge, $x_2$ is the center of the falling edge, $a$ is the maximum of the pulse over the noise floor, and $y_0$ is the noise floor. A sample fitting is shown in \autoref{pulseshapes}. We enforce $x_1<x_2$ and use suitable automatically calculated initial values for our fitting. This fitting converges on almost all pulses it has been applied to. A sample collection of ADC recordings are shown in \autoref{tracepanel}.


\begin{figure}[H]
\centering
\includegraphics[width=6 in]{./images/signals.pdf}
\caption[Synchronization Cable Timing Diagram]{In this figure from Ricardo Sato, we have the time structure of the ADC traces in Trak Jr. and Clais Jr. This diagram serves to label the various time differences in the problem of finding the UUB's time resolution via synchronization cable.}
\label{ricardodiag}
\end{figure}
If we look to \autoref{ricardodiag}, we can see some of the time structure of the shower and Calibration pulses. Consider that the ADC from Clais Jr. ends at $t_{Clais}$ and the ADC trace from Trak ends at $t_{Trak}$ and these are both absolute GPS times. Then the time when Clais Jr. was triggered is $t_{trig}=t_{Clais}-dt_{trig}$. As mentioned above, $dt_{trig}$ is a fixed quantity representing 1/3 of the way into the trace. As denoted in the diagram, the time that Trak Jr. will see this pulse is $t_{sync}=t_{Trak}-dt_{trig}+dt_{pulse}$. the times we will histogram are then:
\begeq{
  t_{diff}=t_{sync}-t_{trig}=t_{Clais}-t_{Trak}+dt_{pulse}.
}
The total observed time differences from the stations result in a standard deviation of:
$$\sigma_{tot}=\sqrt{\sigma_{det1}^2+\sigma_{det2}^2}=\sqrt{2\sigma_{det}^2}\implies\sigma_{det}=\sqrt{\frac{\sigma_{tot}}{2}},$$
where $\sigma_{tot}=\sigma(t_{diff})$. With this stated, we have our complete method of timing analysis using the synchronization cable.
\begin{figure}[p]
\centering
\includegraphics[width=6 in]{./images/tracepanel.pdf}
\caption[ADC Trace Panel]{This panel of ADC traces corresponds to one air shower in the engineering array. We can see, for example in the high gain channel (2nd down on the left), the air shower wavefront and in the 8th pane on the left, we have the synchronization pulse.}
\label{tracepanel}
\end{figure}
\newpage
%the autoanalyzer you made has a bunch of amazing plots for this, go grab them!
\subsection{Synchronization Cable Results}
Taking data from the month of June 2018, we run our analysis as described in the previous section. The histogram and fit of time differences are shown in \autoref{syncdiff}, where we can see that the standard deviation of the fit Gaussian is $\sigma_{tot}=11.94\pm.21$ns, which gives us a final result:
\begeq{
  \sigma_{det}=\frac{\sigma_{tot}}{\sqrt{2}}=8.44\,\pm\,.15\mbox{ ns}.
}
\begin{figure}[H]
\centering
\includegraphics[width=5.5 in]{./images/newfit_analysis.pdf}
\caption[Sync-Cable Histogram of $t_{diff}$]{Here we have the final $t_{diff}$ histogram with the standard deviation from the fit labeled on it.}
\label{syncdiff}
\end{figure}
\subsection{Conclusions}
In this section we discussed two different methods of getting the time resolution of the UUB. One of these, the `coincident showers' method required us to calculate a factor representing the physical dispersion in timing caused by the directionality of the air showers. After surveying different energy ranges and finding that the highest energy cuts provided a good Gaussian fit, while retaining the same calculated standard deviation of all other energy ranges investigated. We used the parameters from this fit to estimate a $\sim$18ns dispersion factor which, when subtracted in quadrature from the measured $\sim$22ns uncorrected time resolution, gave us a final measurement from the first method of $\sigma_{det}=8.8 \,\pm\, 3.6 \mbox{ ns}$. 

After this method, we discussed the `synchronization cable' method, in which we time the arrival of a pulse from one station to the other. Since we need to calculate GPS time stamps at both stations, as well as track the arrival time using an ADC, this method provides a true end-to-end test of the timing resolution. Following this route, we arrive at a time resolution of $\sigma_{det}=8.44\pm\,.15\mbox{ ns}$.

Given the large uncertainty induced from the calculation of the physical dispersion due to directionality of the arriving showers, we find that the `synchronization cable' method is a better measurement of the time resolution. We therefore accept $\sigma_{det}=8.44\pm\,.15\mbox{ ns}$ as our final measurement, although the measurement using the `coincident showers' method is in good agreement with this result.

























